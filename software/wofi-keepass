#!/usr/bin/env bash
# Simple KeePassXC + Wofi password picker for Sway/Wayland
# by ChatGPT

DB_PATH="/home/marco/mojufer/Documents/Admin/keyPassXC/Passwords.kdbx"
KEY_FILE="/home/marco/.keys/keypassxc"
KEEPASS_CLI="/usr/bin/keepassxc-cli"

# Wofi config from sway config variable ($menu)
WOFI_CMD="wofi --show run"

# You can override Wofi look/feel here if needed
# Example: WOFI_CMD="wofi --dmenu --prompt='Passwords:'"

# Ensure database and key exist
if [[ ! -f "$DB_PATH" ]]; then
  notify-send "KeePassXC" "Database not found: $DB_PATH"
  exit 1
fi

if [[ ! -f "$KEY_FILE" ]]; then
  notify-send "KeePassXC" "Key file not found: $KEY_FILE"
  exit 1
fi

# List entries
echo list entries
entries=$($KEEPASS_CLI ls -R "$DB_PATH" --no-password --key-file "$KEY_FILE" 2>/dev/null)


if [[ -z "$entries" ]]; then
  notify-send "KeePassXC" "No entries found or database locked."
  exit 1
fi

# Choose entry
echo choose entry
selection=$(echo "$entries" | $WOFI_CMD --prompt "Password entry:" --dmenu)
selection=$(echo "$selection" | xargs)
[[ -z "$selection" ]] && exit 0

# Get password and copy to clipboard
echo $selection
# password=$($KEEPASS_CLI show -s -a Password "$DB_PATH" "$selection" --no-password --key-file "$KEY_FILE" 2>/dev/null)
password="$("$KEEPASS_CLI" show -s -a Password "$DB_PATH" "$selection" --no-password --key-file "$KEY_FILE" 2>/dev/null)"


if [[ -z "$password" ]]; then
  notify-send "KeePassXC" "Failed to get password for $selection"
  exit 1
fi

# Copy securely
echo -n "$password" | wl-copy

# Schedule clipboard clearing in the background after 30 seconds
(
    sleep 30
    # Only clear if clipboard still contains this password
    current_clip=$(wl-paste)
    if [[ "$current_clip" == "$password" ]]; then
        echo -n "" | wl-copy
    fi
) &
